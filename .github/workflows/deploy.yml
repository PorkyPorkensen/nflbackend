name: Deploy to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Create deployment package
      run: |
        echo "Creating deployment package..."
        
        # Create deployment directory
        mkdir -p deployment
        
        # Copy all files except excluded ones
        rsync -av --exclude='.env' --exclude='.vscode/' --exclude='.github/' --exclude='node_modules/' --exclude='.git/' --exclude='*.log' --exclude='.elasticbeanstalk/' --exclude='.gitignore' ./ deployment/
        
        echo "Files in deployment package:"
        ls -la deployment/
        
        # Create ZIP from deployment directory
        cd deployment
        zip -r ../deploy.zip .
        cd ..
        
        echo "Deployment package created:"
        ls -lh deploy.zip

    - name: Deploy to Elastic Beanstalk
      run: |
        # Upload ZIP to S3
        aws s3 cp deploy.zip s3://nfl-backend-deployments/${{ github.sha }}.zip
        
        # Create application version
        aws elasticbeanstalk create-application-version \
          --application-name nfl-backend \
          --version-label ${{ github.sha }} \
          --description "Deploy ${{ github.sha }}" \
          --source-bundle S3Bucket=nfl-backend-deployments,S3Key=${{ github.sha }}.zip
        
        # Deploy to environment
        aws elasticbeanstalk update-environment \
          --application-name nfl-backend \
          --environment-name nfl-prod \
          --version-label ${{ github.sha }}