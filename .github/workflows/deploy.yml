name: Deploy to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Create deployment package
      run: |
        echo "Creating deployment package..."
        
        # Create deployment directory
        mkdir -p deployment
        
        # Copy all files and directories (excluding deployment itself)
        for item in * .*; do
          if [ "$item" != "." ] && [ "$item" != ".." ] && [ "$item" != "deployment" ]; then
            cp -r "$item" deployment/ 2>/dev/null || true
          fi
        done
        
        # Remove excluded files from deployment directory
        cd deployment
        rm -rf .env .vscode .github node_modules .git .gitignore .elasticbeanstalk
        rm -f *.log
        
        echo "Files in deployment package:"
        ls -la
        
        # Create ZIP
        zip -r ../deploy.zip .
        cd ..
        
        echo "Deployment package created:"
        ls -lh deploy.zip

    - name: Deploy to Elastic Beanstalk
      run: |
        set -e  # Exit on any error
        
        echo "Checking Elastic Beanstalk application..."
        aws elasticbeanstalk describe-applications --application-names nfl-backend
        
        echo "Checking Elastic Beanstalk environment..."
        aws elasticbeanstalk describe-environments --application-name nfl-backend
        
        echo "Uploading ZIP to S3..."
        aws s3 cp deploy.zip s3://nfl-backend-deployments/${{ github.sha }}.zip
        
        echo "Creating application version..."
        aws elasticbeanstalk create-application-version \
          --application-name nfl-backend \
          --version-label ${{ github.sha }} \
          --description "Deploy ${{ github.sha }}" \
          --source-bundle S3Bucket=nfl-backend-deployments,S3Key=${{ github.sha }}.zip
        
        echo "Deploying to environment..."
        aws elasticbeanstalk update-environment \
          --application-name nfl-backend \
          --environment-name prod \
          --version-label ${{ github.sha }}
        
        echo "Deployment initiated successfully!"